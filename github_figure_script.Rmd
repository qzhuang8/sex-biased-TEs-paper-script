## This R markdown file is a collection of script to generate Figures used 
## for the sex-biased TE paper. 



### Libraries and variables 

```{r}
### Libraries
suppressMessages(library(tidyverse))
suppressMessages(library(readxl))
suppressMessages(library(dplyr))  
suppressMessages(library(ggsignif)) 
suppressMessages(library(ggpubr))
suppressMessages(library(annotatr)) 
suppressMessages(library(UpSetR))
suppressMessages(library(ggplot2)) 
suppressMessages(library(ComplexHeatmap))
suppressMessages(library(GenomicRanges))

suppressMessages(library(DESeq2))
suppressMessages(library(purrr))
suppressMessages(library(rGREAT)) 


```


### Variables

```{r}
## User needs to modify this variable accordingly to local dir 
dir_github_script <- "G:/My Drive/github_script/"

```


### Figure 1.

```{r}


## Figure 1 Organ-specific expression patterns 

### Read in formatted count matrix. 
#### Figure 1A
four_organs_gene_reformatted_v2 <- readRDS(file = paste0(dir_github_script, 
                                                         "rds_files/four_organs_gene_reformatted_v2.rds"))
four_organs_lncRNA_exp_raw_normalized <- readRDS(file = paste0(dir_github_script, 
                                                               "rds_files/four_organs_lncRNA_exp_raw_normalized.rds"))
four_organs_TE_subfamily_reformatted_v2 <- readRDS(file = paste0(dir_github_script, 
                                                               "rds_files/four_organs_TE_subfamily_reformatted_v2.rds"))
#### Figure 1B
heatmap_four_organ_normalized <- readRDS(file = paste0(dir_github_script,
                                                            "rds_files/heatmap_four_organ_normalized.rds"))
#### Figure 1C
Figure_1c_normalized_all_TEinstance <- readRDS(file = paste0(dir_github_script,
                                                        "rds_files/Figure_1c_normalized_all_TEinstance.rds"))



### Generate Figures - Fig 1A. PCA of gene expression: four organs
#### Gene
##### Necessary formatting to run plotPCA
cts_four_organs_gene <- four_organs_gene_reformatted_v2 %>% dplyr::select(where(is.numeric)) %>% t()
cts_four_organs_gene[is.na(cts_four_organs_gene)] <- 0
row.names(cts_four_organs_gene) <- four_organ_gene_exp_filtered$Gene

##### Necessary formatting to run plotPCA - data matrix
dds_four_organs_gene <- DESeqDataSetFromMatrix(countData = cts_four_organs_gene,
                                               colData = four_organs_gene_reformatted_v2,
                                               design = ~ Organ)

vsd_four_organs_gene <- vst(dds_four_organs_gene, blind=FALSE)

##### Plot Figure 1A - gene
pd_four_organs_gene <- plotPCA(vsd_four_organs_gene, intgroup=c("Organ"),  ntop = 300) + 
  aes(shape = Organ, color = Organ) + theme_classic() + 
  scale_shape_manual(values = c(1, 0, 2, 3),
                     labels = c("Brain (18)",
                                "Heart (16)",
                                "Liver (21)",
                                "Lung (16)")) + 
  scale_color_manual(values = four_organs_colors,
                     labels = c("Brain (18)",
                                "Heart (16)",
                                "Liver (21)",
                                "Lung (16)"))+
  ylim(-40, 45)

##### Save Figure 1A - gene
ggsave(filename = paste0(dir_github_script, "Figures/Figure_1A_PCA_gene.png"),
       pd_four_organs_gene, width = 3, height = 3)

#### lncRNA
##### Necessary formatting to run plotPCA
four_organs_lncRNA_data <- four_organs_lncRNA_exp_raw_normalized_v2 %>% as_tibble()

##### Necessary formatting to run plotPCA - data matrix
dds_four_organs_lncRNA <- DESeqDataSetFromMatrix(countData = four_organs_lncRNA_exp_raw_normalized,
                                         colData = four_organs_lncRNA_data,
                                         design = ~ Organ)

vsd_four_organs_lncRNA <- vst(dds_four_organs_lncRNA, blind=FALSE)

##### Plot Figure 1A - lncRNA
pd_four_organs_lncRNA <- plotPCA(vsd_four_organs_lncRNA, intgroup=c("Organ"),  ntop = 300)   +  
  aes(shape = Organ, color = Organ) +
  theme_classic() + scale_shape_manual(values = c(1, 0, 2, 3),
                                       labels = c("Brain (18)",
                                                  "Heart (16)",
                                                  "Liver (21)",
                                                  "Lung (16)")) + 
  scale_color_manual(values = four_organs_colors,
                     labels = c("Brain (18)",
                                "Heart (16)",
                                "Liver (21)",
                                "Lung (16)"))

##### Plot Figure 1A - lncRNA
ggsave(filename = paste0(dir_github_script, "Figures/Figure_1A_PCA_lncRNA.png"),
       pd_four_organs_lncRNA, width = 3, height = 3)


#### TE subfamily
##### Necessary formatting to run plotPCA
cts_four_organs_TE_subfamily <- four_organs_TE_subfamily_reformatted_v2 %>% dplyr::select(where(is.numeric)) %>% t()
cts_four_organs_TE_subfamily[is.na(cts_four_organs_TE_subfamily)] <- 0
row.names(cts_four_organs_TE_subfamily) <- four_organ_TE_subfamily_exp_filtered$Gene
dds_four_organs_TE_subfamily <- DESeqDataSetFromMatrix(countData = cts_four_organs_TE_subfamily,
                                                       colData = four_organs_TE_subfamily_reformatted_v2,
                                                       design = ~ Organ)
vsd_four_organs_TE_subfamily <- vst(dds_four_organs_TE_subfamily, blind=FALSE)

##### Plot Figure 1A - TE subfamily
pd_four_organs_TE_subfamily <- plotPCA(vsd_four_organs_TE_subfamily, intgroup=c("Organ"), ntop = 300) +
  aes(shape = Organ, color = Organ) + theme_classic() + 
  scale_shape_manual(values = c(1, 0, 2, 3),
                                       labels = c("Brain (18)",
                                                  "Heart (16)",
                                                  "Liver (21)",
                                                  "Lung (16)")) + 
  scale_color_manual(values = four_organs_colors,
                     labels = c("Brain (18)",
                                "Heart (16)",
                                "Liver (21)",
                                "Lung (16)"))

##### Plot Figure 1A - TE subfamily
ggsave(filename = paste0(dir_github_script, "Figures/Figure_1A_PCA_TE.png"),
       pd_four_organs_TE_subfamily, width = 3, height = 3)


### Generate Figures - Fig 1B. Heatmap of TE expression (TE subfamily)
four_organ_normalized_raw_2a = Heatmap(heatmap_four_organ_normalized,
                                       cluster_columns =  FALSE,
                                       show_row_names = FALSE,
                                       heatmap_legend_param = list(title = "  Exp\nZ-score"))

png(filename = paste0(dir_github_script,
                      "Figures/Figure_1B_heatmap.png"), width = 1080, height = 1080)
four_organ_normalized_raw_2a
dev.off()

### Generate Figures - Fig 1C. Violin plot of organ-biased TE instances
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
my_comparisons2 <- list( c("Brain", "Heart"), c("Brain", "Liver"), c("Brain", "Lung"),
                         c("Heart", "Liver"), c("Heart", "Lung"), c("Liver", "Lung"))
organ_biased_TEinstance_expression_plot <- ggplot(data = Figure_1c_normalized_all_TEinstance ,
                                                    aes(x = Organ, color = Organ, y= log2(TE_count))) + 
  geom_violin() +
  geom_boxplot(position = position_dodge(0.9), width = 0.1)+
  facet_grid(. ~ organ_biased) +
  labs(x = "") +
  theme_classic() +
  scale_colour_manual(values=cbbPalette[c(7, 4, 6, 8, 1)]) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 1))

ggsave(filename = paste0(dir_github_script,
                         "Figures/Figure_1C_violinPlot.png"),
       organ_biased_TEinstance_expression_plot, width = 6, height = 4)


```


### Figure 2.

```{r}

```

### Figure 3.

```{r}

```


